<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T√≠nh L√£i Su·∫•t Vay (C·ªßa Thi√™n) ‚Äì B·∫£n N√¢ng Cao 2025</title>
  <style>
    :root{
      --primary:#007bff;
      --bg:#f5faff;
      --card-grad:linear-gradient(135deg,#d0e6f7,#f5faff);
      --text:#0f172a;
      --muted:#475569;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:0;
      font-family:Arial, Helvetica, sans-serif;
      background:var(--bg); color:var(--text);
      line-height:1.5;
    }

    /* Marquee full-bleed */
    .marquee{width:100vw; position:relative; overflow:hidden; background:var(--primary); color:#fff; padding:12px 0; font-weight:bold; font-size:16px; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw;}
    .marquee-content{display:inline-block; white-space:nowrap; animation:marquee 15s linear infinite; padding-left:100vw}
    .marquee:hover .marquee-content{animation-play-state:paused}
    @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)} }

    .container{max-width:900px; margin:20px auto; padding:20px; background:var(--card-grad); border-radius:var(--radius); box-shadow:0 10px 30px rgba(2,6,23,.08)}
    h1{margin:0 auto 12px; text-align:center; border:2px solid var(--primary); display:inline-block; padding:10px 20px; border-radius:8px; font-size:28px}
    .subtitle{margin:0 auto 20px; text-align:center; color:var(--muted); font-size:14px}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    label{display:block; font-weight:600; font-size:14px}
    input, select{
      width:100%; padding:10px 12px; margin-top:6px; font-size:16px; border:1px solid #cbd5e1; border-radius:10px; outline:none; background:#fff;
    }
    input:focus, select:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(0,123,255,.15)}

    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .actions{margin-top:14px; display:flex; flex-wrap:wrap; gap:10px}
    button{padding:12px 16px; font-size:16px; cursor:pointer; border:none; border-radius:12px; background:var(--primary); color:#fff; box-shadow:0 6px 16px rgba(0,123,255,.2)}
    button.secondary{background:#0ea5e9}
    button.ghost{background:#e2e8f0; color:#0f172a}

    .note{margin-top:10px; font-style:italic; color:#334155}

    table{border-collapse:collapse; width:100%; margin-top:20px; background:#fff; border-radius:12px; overflow:hidden}
    table th, table td{border:1px solid #e2e8f0; padding:10px; text-align:center; font-size:15px}
    table th{background:#f1f5f9}

    footer{text-align:center; margin-top:28px; font-size:14px; color:#555}

    .pill{display:inline-block; border:1px dashed #93c5fd; padding:6px 10px; border-radius:999px; background:#eff6ff; color:#0c4a6e; font-size:13px}

    .warn{background:#fff7ed; border:1px solid #fdba74; padding:10px 12px; border-radius:10px; color:#9a3412; font-size:14px}

    @media (max-width:720px){
      h1{font-size:22px; padding:8px 16px}
      .marquee{font-size:14px; padding:10px 0}
      .grid{grid-template-columns:1fr}
      button{width:100%}
      table th, table td{font-size:13px}
      a[href*="zalo"] img{width:54px; height:54px}
    }
  </style>
</head>
<body>
  <!-- Marquee full m√†n h√¨nh -->
  <div class="marquee" aria-label="thong-bao">
    <div class="marquee-content">üí∏ Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi c√¥ng c·ª• T√≠nh L√£i Su·∫•t Vay c·ªßa Team NG·ªåC TR√ÇN! üìû Zalo: 0964 307 247 ‚Äì H·ªó tr·ª£ nhanh, uy t√≠n, linh ho·∫°t! üöÄ</div>
  </div>

  <div class="container">
    <h1>T√≠nh L√£i Su·∫•t Vay Team Ng·ªçc Tr√¢n</h1>
    <p class="subtitle"><span class="pill">B·∫£n n√¢ng cao ‚Ä¢ Chu·∫©n vi-VN ‚Ä¢ C√≥ Excel & PDF ‚Ä¢ T√πy ch·ªçn l√£i k·ª≥ ƒë·∫ßu theo ng√†y</span></p>

    <div class="grid" role="form" aria-label="loan-form">
      <div>
        <label>Ng√†y Gi·∫£i Ng√¢n
          <input type="date" id="disbursalDate" />
        </label>
      </div>
      <div>
        <label>Ng√†y K·ª≥ ƒê√≥ng ƒê·∫ßu Ti√™n
          <input type="date" id="firstEmiDate" />
        </label>
      </div>
      <div>
        <label>S·ªë Ti·ªÅn Vay (VND)
          <input type="text" id="loanAmount" inputmode="numeric" placeholder="VD: 100.000.000" oninput="formatNumber(this)" />
        </label>
      </div>
      <div>
        <label>% B·∫£o Hi·ªÉm Kho·∫£n Vay (n·∫øu c√≥)
          <input type="number" id="insurancePercent" value="7.7" step="0.1" />
        </label>
      </div>
      <div>
        <label>L√£i Su·∫•t (%/nƒÉm)
          <input type="number" id="interestRate" value="52" step="0.01" />
        </label>
      </div>
      <div>
        <label>S·ªë K·ª≥ Vay (th√°ng)
          <input type="number" id="months" value="24" min="1" />
        </label>
      </div>
      <div>
        <label>Ph√≠ Thu H·ªô m·ªói k·ª≥ (VND)
          <input type="text" id="collectionFee" value="12.000" oninput="formatNumber(this)" />
        </label>
      </div>
      <div class="row" style="align-items:flex-end">
        <label style="width:100%">
          <input type="checkbox" id="proRateFirst" checked /> T√≠nh l√£i theo ng√†y cho k·ª≥ ƒë·∫ßu (t·ª´ ng√†y gi·∫£i ng√¢n ‚Üí k·ª≥ 1)
        </label>
      </div>
    </div>

    <div class="actions">
      <button onclick="calculateLoan()">T√≠nh L·ªãch Thanh To√°n</button>
      <button class="secondary" onclick="exportExcel()">Xu·∫•t Excel</button>
      <button class="ghost" onclick="downloadPDF()">T·∫£i PDF</button>
      <button class="ghost" onclick="resetForm()">Nh·∫≠p L·∫°i</button>
    </div>

    <div id="alerts" style="margin-top:12px"></div>
    <div id="summary" style="margin-top:12px"></div>
    <div id="result"></div>

    <p class="note">* ƒê√¢y l√† b·∫£ng tham kh·∫£o. ƒêi·ªÅu kho·∫£n th·ª±c t·∫ø c√≥ th·ªÉ thay ƒë·ªïi theo h·ªì s∆° v√† ch√≠nh s√°ch th·ªùi ƒëi·ªÉm.</p>

    <footer>
      ¬© 2025 V√µ Qu·ªëc Thi√™n ‚Äì Gi·∫£i Ph√°p Vay Ti√™u D√πng Uy T√≠n & Linh Ho·∫°t <br>
      <a href="https://www.hitwebcounter.com" target="_blank" rel="noopener">
        <img src="https://hitwebcounter.com/counter/counter.php?page=21221472&style=0002&nbdigits=6&type=page&initCount=0" alt="ƒê·∫øm l∆∞·ª£t truy c·∫≠p" />
      </a>
      <div style="font-size:14px; color:#333; margin-top:5px">L∆∞·ª£t Truy C·∫≠p</div>
    </footer>
  </div>

  <!-- Th∆∞ vi·ªán SheetJS cho Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Th∆∞ vi·ªán html2pdf ƒë·ªÉ xu·∫•t PDF g·ªçn ƒë·∫πp -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // ===== Helpers ƒë·ªãnh d·∫°ng =====
    function viNumber(n){
      return Number(n || 0).toLocaleString('vi-VN');
    }
    function formatNumber(input){
      const value = (input.value||'').replace(/\D/g,'');
      input.value = value ? viNumber(value) : '';
    }
    function parseNumber(str){
      if(!str) return 0;
      return Number(String(str).replace(/\./g,'').replace(/\s/g,'')) || 0;
    }

    function daysBetween(d1, d2){
      const one = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
      const two = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
      return Math.round((two - one) / (1000*60*60*24));
    }

    function validateInputs(){
      const alerts = [];
      const disbursalDate = new Date(document.getElementById('disbursalDate').value);
      const firstEmiDate = new Date(document.getElementById('firstEmiDate').value);
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      const insurancePercent = Number(document.getElementById('insurancePercent').value);
      const interestRate = Number(document.getElementById('interestRate').value);
      const months = Number(document.getElementById('months').value);

      if(!document.getElementById('disbursalDate').value) alerts.push('Vui l√≤ng ch·ªçn Ng√†y Gi·∫£i Ng√¢n.');
      if(!document.getElementById('firstEmiDate').value) alerts.push('Vui l√≤ng ch·ªçn Ng√†y K·ª≥ ƒê√≥ng ƒê·∫ßu Ti√™n.');
      if(loanAmount <= 0) alerts.push('S·ªë ti·ªÅn vay ph·∫£i > 0.');
      if(months < 1) alerts.push('S·ªë k·ª≥ vay t·ªëi thi·ªÉu l√† 1.');
      if(interestRate <= 0) alerts.push('L√£i su·∫•t nƒÉm ph·∫£i > 0.');
      if(firstEmiDate <= disbursalDate) alerts.push('K·ª≥ ƒë√≥ng ƒë·∫ßu ph·∫£i sau ng√†y gi·∫£i ng√¢n.');

      return { valid: alerts.length === 0, alerts, values: {disbursalDate, firstEmiDate, loanAmount, insurancePercent, interestRate, months} };
    }

    function calculateLoan(){
      const { valid, alerts, values } = validateInputs();
      const alertBox = document.getElementById('alerts');
      if(!valid){
        alertBox.innerHTML = '<div class="warn">' + alerts.map(a=>`‚Ä¢ ${a}`).join('<br>') + '</div>';
        document.getElementById('result').innerHTML = '';
        document.getElementById('summary').innerHTML = '';
        return;
      } else { alertBox.innerHTML = ''; }

      const {disbursalDate, firstEmiDate, loanAmount, insurancePercent, interestRate, months} = values;
      const collectionFee = parseNumber(document.getElementById('collectionFee').value) || 0;
      const proRateFirst = document.getElementById('proRateFirst').checked;

      const insurance = loanAmount * insurancePercent / 100;
      const totalLoan = loanAmount + insurance;
      const monthlyRate = interestRate / 12 / 100;

      // EMI chu·∫©n (annuity)
      const pow = Math.pow(1 + monthlyRate, months);
      const EMI = totalLoan * monthlyRate * pow / (pow - 1);

      // T√≥m t·∫Øt
      document.getElementById('summary').innerHTML = `
        <div class="row">
          <div class="pill">T·ªïng vay + BH: <b>${viNumber(totalLoan)}</b> VND</div>
          <div class="pill">Ph√≠ thu h·ªô/k·ª≥: <b>${viNumber(collectionFee)}</b> VND</div>
          <div class="pill">EMI (ch∆∞a g·ªìm ph√≠): <b>${viNumber(Math.round(EMI))}</b> VND</div>
          <div class="pill">T·ªïng ƒë√≥ng/th√°ng (g·ªìm ph√≠): <b>${viNumber(Math.round(EMI + collectionFee))}</b> VND</div>
        </div>`;

      let html = `<table id="repaymentTable"><thead><tr>
        <th>K·ª≥</th><th>Ng√†y Thanh To√°n</th><th>Ti·ªÅn G·ªëc</th><th>Ti·ªÅn L√£i</th><th>Ph√≠ Thu H·ªô</th><th>T·ªïng Thanh To√°n</th><th>D∆∞ N·ª£ C√≤n L·∫°i</th>
      </tr></thead><tbody>`;

      let remaining = totalLoan;

      // K·ª≥ 1: t√πy ch·ªçn t√≠nh l√£i theo ng√†y t·ª´ ng√†y gi·∫£i ng√¢n ‚Üí Ng√†y k·ª≥ 1
      let startDate = new Date(disbursalDate);
      for(let i=1; i<=months; i++){
        const payDate = new Date(firstEmiDate);
        payDate.setMonth(firstEmiDate.getMonth() + (i-1));

        let interest;
        if(i === 1 && proRateFirst){
          const days = Math.max(1, daysBetween(startDate, payDate));
          const dailyRate = (interestRate/100)/365;
          interest = remaining * dailyRate * days;
        } else {
          interest = remaining * monthlyRate;
        }

        let principal = EMI - interest;
        // b·∫£o v·ªá khi l√£i > EMI (tr∆∞·ªùng h·ª£p k·ª≥ ƒë·∫ßu qu√° d√†i)
        if(principal < 0){ principal = 0; }

        // ƒêi·ªÅu ch·ªânh k·ª≥ cu·ªëi ƒë·ªÉ h·∫øt d∆∞ n·ª£ do l√†m tr√≤n
        if(i === months){ principal = remaining; }

        const totalPay = principal + interest + collectionFee;
        const nextRemaining = remaining - principal;

        html += `<tr>
          <td>${i}</td>
          <td>${payDate.toLocaleDateString('vi-VN')}</td>
          <td>${viNumber(Math.round(principal))}</td>
          <td>${viNumber(Math.round(interest))}</td>
          <td>${viNumber(collectionFee)}</td>
          <td>${viNumber(Math.round(totalPay))}</td>
          <td>${viNumber(Math.max(0, Math.round(nextRemaining)))}</td>
        </tr>`;

        remaining = nextRemaining;
        startDate = new Date(payDate);
      }

      html += `</tbody></table>`;
      document.getElementById('result').innerHTML = html;
    }

    function resetForm(){
      ['disbursalDate','firstEmiDate','loanAmount','insurancePercent','interestRate','months','collectionFee'].forEach(id=>{
        const el = document.getElementById(id);
        if(id==='insurancePercent'){ el.value = 7.7; }
        else if(id==='interestRate'){ el.value = 52; }
        else if(id==='months'){ el.value = 24; }
        else if(id==='collectionFee'){ el.value = '12.000'; }
        else { el.value = ''; }
      });
      document.getElementById('proRateFirst').checked = true;
      document.getElementById('alerts').innerHTML='';
      document.getElementById('summary').innerHTML='';
      document.getElementById('result').innerHTML='';
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function exportExcel(){
      const table = document.getElementById('repaymentTable');
      if(!table){ alert('Vui l√≤ng t√≠nh l·ªãch thanh to√°n tr∆∞·ªõc khi xu·∫•t Excel.'); return; }
      const wb = XLSX.utils.table_to_book(table, { sheet: 'LichThanhToan' });
      XLSX.writeFile(wb, 'Lich_Thanh_Toan.xlsx');
    }

    function downloadPDF(){
      const table = document.getElementById('repaymentTable');
      if(!table){ alert('Vui l√≤ng t√≠nh l·ªãch thanh to√°n tr∆∞·ªõc khi t·∫£i PDF.'); return; }
      const node = document.createElement('div');
      node.style.padding = '12px';
      node.innerHTML = `
        <h2 style="text-align:center;margin:0 0 10px">L·ªãch Thanh To√°n ‚Äì ${new Date().toLocaleDateString('vi-VN')}</h2>
        ${document.getElementById('summary').innerHTML}
        ${table.outerHTML}
        <p style="font-style:italic;margin-top:8px">* B·∫£ng mang t√≠nh ch·∫•t tham kh·∫£o.</p>`;
      const opt = { filename: 'Lich_Thanh_Toan.pdf', margin:10, image:{type:'jpeg', quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'mm', format:'a4', orientation:'portrait'} };
      html2pdf().from(node).set(opt).save();
    }
  </script>

  <!-- Icon Zalo n·ªïi -->
  <a href="https://zalo.me/0964307247" target="_blank" rel="noopener" style="position:fixed; bottom:20px; right:20px; z-index:999; text-decoration:none">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/1024px-Icon_of_Zalo.svg.png" alt="Zalo" style="width:60px; height:60px; filter: drop-shadow(0 6px 12px rgba(2,6,23,.25)); border-radius:14px; background:#fff" />
  </a>
</body>
</html>
