<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T√≠nh L√£i Su·∫•t Vay (Team Ng·ªçc Tr√¢n) ‚Äì B·∫£n N√¢ng Cao</title>
  <style>
    :root{
      --primary:#007bff; --bg:#f5faff; --card-grad:linear-gradient(135deg,#d0e6f7,#f5faff);
      --text:#0f172a; --muted:#475569; --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Arial, Helvetica, sans-serif; background:var(--bg); color:var(--text); line-height:1.5}

    .marquee{width:100vw; overflow:hidden; background:var(--primary); color:#fff; padding:12px 0; font-weight:bold; font-size:16px}
    .marquee-content{display:inline-block; white-space:nowrap; animation:marquee 15s linear infinite; padding-left:100vw}
    .marquee:hover .marquee-content{animation-play-state:paused}
    @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

    .container{max-width:1100px; margin:20px auto; padding:20px; background:var(--card-grad); border-radius:var(--radius); box-shadow:0 10px 30px rgba(2,6,23,.08)}
    h1{margin:0 auto 12px; text-align:center; border:2px solid var(--primary); display:inline-block; padding:10px 20px; border-radius:8px; font-size:26px}
    .subtitle{margin:0 auto 18px; text-align:center; color:var(--muted); font-size:13px}

    .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px}
    label{display:block; font-weight:600; font-size:14px}
    input, select{width:100%; padding:10px 12px; margin-top:6px; font-size:16px; border:1px solid #cbd5e1; border-radius:10px; outline:none; background:#fff}
    input:focus, select:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(0,123,255,.12)}

    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .actions{margin-top:14px; display:flex; flex-wrap:wrap; gap:10px}
    button{padding:12px 16px; font-size:16px; cursor:pointer; border:none; border-radius:12px; background:var(--primary); color:#fff; box-shadow:0 6px 16px rgba(0,123,255,.16)}
    button.secondary{background:#0ea5e9}
    button.ghost{background:#e2e8f0; color:#0f172a}

    .note{margin-top:10px; font-style:italic; color:#334155}

    table{border-collapse:collapse; width:100%; margin-top:20px; background:#fff; border-radius:10px; overflow:hidden}
    table th, table td{border:1px solid #e2e8f0; padding:10px; text-align:center; font-size:14px}
    table th{background:#f1f5f9; position:sticky; top:0; z-index:1}

    footer{text-align:center; margin-top:28px; font-size:13px; color:#555}

    .pill{display:inline-block; border:1px dashed #93c5fd; padding:6px 10px; border-radius:999px; background:#eff6ff; color:#0c4a6e; font-size:13px}
    .warn{background:#fff7ed; border:1px solid #fdba74; padding:10px 12px; border-radius:10px; color:#9a3412; font-size:14px}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}

    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      h1{font-size:20px; padding:8px 12px}
    }

    #result{
      max-width:1100px;
      margin:0 auto;
      background:transparent;
      padding:0 0 8px 0;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior-x:contain;
    }
    #result table{
      border-radius:0;
      min-width:1100px;
    }

    @media (max-width:600px){
      .container{padding:14px}
      #result table{min-width:unset; font-size:10px}
      table th, table td{padding:4px 6px; font-size:10px}
      #result th:nth-child(1), #result td:nth-child(1){ width:30px }   
      #result th:nth-child(2), #result td:nth-child(2){ width:70px }   
      #result th:nth-child(3), #result td:nth-child(3){ width:65px }   
      #result th:nth-child(4), #result td:nth-child(4){ width:65px }   
      #result th:nth-child(5), #result td:nth-child(5){ width:75px }   
      #result th:nth-child(6), #result td:nth-child(6){ width:85px }   
    }

    @media print{
      .marquee, .actions, .note, footer, .toolbar, .zalo{display:none !important}
      body{background:#fff}
      .container{box-shadow:none; background:#fff}
      thead { display: table-header-group; }
      #result{ margin:0; max-width:none; }
      #result table{ border-radius:0; }
    }

    .zalo-icon {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 9999;
      transition: transform 0.2s;
    }
    .zalo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: #0068ff;
      border-radius: 50%;
      padding: 8px;
    }
    .zalo-icon:hover { transform: scale(1.1); }
  </style>
</head>
<body>
  <div class="marquee">
    <div class="marquee-content">üí∏ Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi c√¥ng c·ª• T√≠nh L√£i Su·∫•t Vay c·ªßa Team Mirae Asset NG·ªåC TR√ÇN! üìû Li√™n h·ªá Zalo: 0964307247 ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ nhanh ch√≥ng v√† uy t√≠n! üöÄ</div>
  </div>

  <div class="container" id="main">
    <h1>C√¥ng C·ª• T√≠nh L√£i Su·∫•t-Team Ng·ªçc Tr√¢n</h1>
    <p class="subtitle"><span class="pill">B·∫£n n√¢ng cao ‚Ä¢ Chu·∫©n vi-VN ‚Ä¢ Excel/PDF ‚Ä¢ 30/360 ‚Ä¢ L√†m tr√≤n</span></p>

    <div class="grid" role="form" aria-label="loan-form">
      <div><label>Ng√†y Gi·∫£i Ng√¢n</label><input type="date" id="disbursalDate" /></div>
      <div><label>Ng√†y K·ª≥ ƒê√≥ng ƒê·∫ßu Ti√™n</label><input type="date" id="firstEmiDate" /></div>
      <div><label>S·ªë Ti·ªÅn Vay (VND)</label><input type="text" id="loanAmount" inputmode="numeric" placeholder="VD: 20.000.000" /></div>
      <div><label>% B·∫£o Hi·ªÉm Kho·∫£n Vay (n·∫øu c√≥)</label><input type="number" id="insurancePercent" value="7.7" step="0.1" min="0" /></div>
      <div><label>L√£i Su·∫•t (%/nƒÉm)</label><input type="number" id="interestRate" value="52" step="0.01" min="0.01" /></div>
      <div><label>S·ªë K·ª≥ Vay (th√°ng)</label><input type="number" id="months" value="24" min="1" /></div>
      <div class="row" style="align-items:flex-end">
        <label style="width:100%"><input type="checkbox" id="proRateFirst" checked /> T√≠nh l√£i theo ng√†y cho k·ª≥ ƒë·∫ßu</label>
      </div>
    </div>

    <div class="actions">
      <button id="btnCalc">T√≠nh L·ªãch Thanh To√°n</button>
      <button class="secondary" id="btnExcel">Xu·∫•t Excel</button>
      <button class="ghost" id="btnPDF">T·∫£i PDF</button>
      <button class="ghost" id="btnCSV">Xu·∫•t CSV</button>
      <button class="ghost" id="btnReset">Nh·∫≠p L·∫°i</button>
    </div>

    <div class="toolbar">
      <label class="row" style="gap:6px"><input type="checkbox" id="remember" checked> L∆∞u th√¥ng tin nh·∫≠p (LocalStorage)</label>
      <button class="ghost" id="btnToday">ƒêi·ªÅn nhanh h√¥m nay</button>
    </div>

    <div id="alerts" style="margin-top:12px"></div>
    <div id="summary" style="margin-top:12px"></div>
  </div>

  <div id="result"></div>

  <div class="container">
    <p class="note">* B·∫£ng t√≠nh mang t√≠nh ch·∫•t tham kh·∫£o. ƒêi·ªÅu kho·∫£n ch√≠nh th·ª©c t√πy theo h·ªì s∆° v√† ch√≠nh s√°ch hi·ªán t·∫°i.</p>
    <footer><b>¬© Copyright 2025 V√µ Qu·ªëc Thi√™n. Gi·∫£i Ph√°p Vay Ti√™u D√πng Uy T√≠n & Linh Ho·∫°t</b></footer>
  </div>

  <!-- Zalo Icon -->
  <a href="https://zalo.me/0964307247" target="_blank" class="zalo-icon">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/91/Icon_of_Zalo.svg" alt="Zalo" />
  </a>

  <!-- B·ªô ƒë·∫øm l∆∞·ª£t truy c·∫≠p Hitwebcounter b·∫Øt ƒë·∫ßu t·ª´ 2534 -->
  <div style="text-align:center; margin:20px 0;">
    <div style="font-weight:bold; margin-bottom:6px;">L∆∞·ª£t Truy C·∫≠p</div>
    <a href="https://www.hitwebcounter.com/compress-pdf" target="_blank">
      <img src="https://hitwebcounter.com/counter/counter.php?page=21437099&style=0006&nbdigits=6&type=page&initCount=2534" 
           title="Compress" 
           alt="Compress" 
           border="0" />
    </a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    function viNumber(n){ return Number(n||0).toLocaleString('vi-VN'); }
    function parseNumber(str){ return Number(String(str).replace(/[^\d]/g,''))||0; }
    function addMonthsKeepDay(date, months){
      const d=new Date(date); const day=d.getDate();
      d.setDate(1); d.setMonth(d.getMonth()+months);
      d.setDate(Math.min(day,new Date(d.getFullYear(),d.getMonth()+1,0).getDate()));
      return d;
    }
    function roundByPolicy(value){ return Math.round(value/1000)*1000; }

    function daysBetween(d1,d2){ return Math.round((d2-d1)/(1000*60*60*24)); }

    function validateInputs(){
      const disbursalDateStr=document.getElementById('disbursalDate').value;
      const firstEmiDateStr=document.getElementById('firstEmiDate').value;
      const loanAmount=parseNumber(document.getElementById('loanAmount').value);
      const insurancePercent=Number(document.getElementById('insurancePercent').value);
      const interestRate=Number(document.getElementById('interestRate').value);
      const months=Number(document.getElementById('months').value);
      if(!disbursalDateStr||!firstEmiDateStr||loanAmount<=0||interestRate<=0||months<1) return null;
      return {disbursalDate:new Date(disbursalDateStr),firstEmiDate:new Date(firstEmiDateStr),loanAmount,insurancePercent,interestRate,months};
    }

    function renderSummary(totalLoan,EMI,months){
      document.getElementById('summary').innerHTML=`<div class="row">
        <div class="pill">T·ªïng vay + BH: <b>${viNumber(totalLoan)}</b> VND</div>
        <div class="pill">S·ªë th√°ng vay: <b>${months}</b></div>
        <div class="pill">Thanh to√°n m·ªói k·ª≥(ƒë√£ bao g·ªìm ph√≠ thu h·ªô) ~ <b>${viNumber(Math.round(EMI+12000))}</b> VND</div>
      </div>`;
    }

    function calculateLoan(){
      const values=validateInputs();
      if(!values){ alert("Vui l√≤ng nh·∫≠p ƒë·ªß d·ªØ li·ªáu"); return; }
      const {disbursalDate,firstEmiDate,loanAmount,insurancePercent,interestRate,months}=values;
      const totalLoan=loanAmount*(1+insurancePercent/100);
      const monthlyRate=interestRate/12/100;
      const EMI=totalLoan*monthlyRate/(1-Math.pow(1+monthlyRate,-months));
      renderSummary(totalLoan,EMI,months);

      let balance=totalLoan;
      let html='<table><thead><tr><th>K·ª≥</th><th>Ng√†y</th><th>G·ªëc</th><th>L√£i</th><th>Thanh to√°n</th><th>D∆∞ n·ª£ cu·ªëi k·ª≥</th></tr></thead><tbody>';

      let prevDate=disbursalDate;
      for(let k=1;k<=months;k++){
        let dueDate;
        if(k===1){ dueDate=firstEmiDate; }
        else if(k<months){ dueDate=addMonthsKeepDay(firstEmiDate,k-1); }
        else{ dueDate=addMonthsKeepDay(firstEmiDate,months-1); }

        let days=daysBetween(prevDate,dueDate);
        if(k<months-1) days=30; 
        if(k===1) days=daysBetween(disbursalDate,firstEmiDate); 
        if(k===months) days=daysBetween(prevDate,dueDate); 

        const interest=roundByPolicy(balance*interestRate*days/360/100);
        const principal=(k<months)? roundByPolicy(EMI-interest) : balance;
        balance=Math.max(0,balance-principal);
        const fee=12000;
        const totalPay=principal+interest+fee;

        html+=`<tr>
          <td>${k}</td>
          <td>${dueDate.toLocaleDateString('vi-VN')}</td>
          <td>${viNumber(principal)}</td>
          <td>${viNumber(interest)}</td>
          <td>${viNumber(totalPay)}</td>
          <td>${viNumber(balance)}</td>
        </tr>`;
        prevDate=dueDate;
      }
      html+='</tbody></table>';
      document.getElementById('result').innerHTML=html;
    }

    function exportExcel(){
      const table=document.querySelector('#result table');
      if(!table){alert('Kh√¥ng c√≥ d·ªØ li·ªáu');return;}
      const wb=XLSX.utils.table_to_book(table,{sheet:"LichTra"});
      XLSX.writeFile(wb,'Lich_Tra.xlsx');
    }
    function exportCSV(){
      const table=document.querySelector('#result table');
      if(!table){alert('Kh√¥ng c√≥ d·ªØ li·ªáu');return;}
      const wb=XLSX.utils.table_to_book(table,{sheet:"LichTra"});
      const csv=XLSX.utils.sheet_to_csv(wb.Sheets["LichTra"]);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='Lich_Tra.csv';
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    function exportPDF(){
      const element=document.getElementById('result');
      if(!element||!element.innerHTML.trim()){alert('Kh√¥ng c√≥ d·ªØ li·ªáu');return;}
      html2pdf().set({margin:0.4,filename:'Lich_Tra.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'in',format:'a4',orientation:'portrait'}}).from(element).save();
    }
    function resetForm(){ location.reload(); }
    function fillToday(){
      const today=new Date();
      document.getElementById('disbursalDate').value=today.toISOString().split('T')[0];
      const first=new Date(today);
      first.setDate(first.getDate()+30);
      document.getElementById('firstEmiDate').value=first.toISOString().split('T')[0];
    }

    document.getElementById('loanAmount').addEventListener('input', function(e){
      let value = e.target.value.replace(/\D/g,'');
      if(value){ e.target.value = Number(value).toLocaleString('vi-VN'); }
      else { e.target.value = ''; }
    });

    document.getElementById('btnCalc').addEventListener('click',calculateLoan);
    document.getElementById('btnExcel').addEventListener('click',exportExcel);
    document.getElementById('btnCSV').addEventListener('click',exportCSV);
    document.getElementById('btnPDF').addEventListener('click',exportPDF);
    document.getElementById('btnReset').addEventListener('click',resetForm);
    document.getElementById('btnToday').addEventListener('click',fillToday);

    // üëâ T·ª± ƒë·ªông ƒëi·ªÅn ng√†y gi·∫£i ng√¢n = h√¥m nay v√† k·ª≥ ƒë·∫ßu ti√™n = sau 30 ng√†y
    window.addEventListener('DOMContentLoaded', fillToday);
  </script>
</body>
</html>
